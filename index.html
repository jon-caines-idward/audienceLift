<html>
<head>
  <title>SecureLift Demo</title>
  <script>
    // create LS keys if required
    (function() {
      const key1 = 'cohort_ids';
      if (!localStorage.getItem(key1)) {
        const cohorts = ["33917"];          
        localStorage.setItem(key1, JSON.stringify(cohorts));
        console.log(`Set localStorage key '${key1}' with cohorts array.`);
      } else {
        console.log(`localStorage key '${key1}' already exists.`);
      }
      const key2 = 'cuid';
      if (!localStorage.getItem(key2)) {
        const cuid = 'f660ab912ec121d1b1e928a0bb4bc61b15f5ad44d5efdc4e1c92a25e99b8e44a';
        localStorage.setItem(key2, cuid);
        console.log(`Set localStorage key '${key2}' with CUID.`);
      } else {
        console.log(`localStorage key '${key2}' already exists.`);
      }
    })();
    // facebook pixel code 
    !function(f,b,e,v,n,t,s){
      if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '275230413602298'); 
      fbq('track', 'PageView');
      (function() {
        const key1 = 'cohort_ids'; 
        const key2 = 'cuid';
        const data1 = localStorage.getItem(key1);
        const data2 = localStorage.getItem(key2);
        if (!data1) {
          console.warn(`localStorage key '${key1}' not found.`);
          return;
        }
        if (!data2) {
          console.warn(`localStorage key '${key2}' not found.`);
          return;
        }
      let cohorts;
      let anonId;
      try {
        cohorts = JSON.parse(data1);
      } catch (e) {
        console.error(`Error parsing JSON from localStorage key '${key1}':`, e);
        return;
      }
      try {
        anonId = data2;
      } catch (e) {
        console.error(`Error getting from localStorage key '${key2}':`, e);
        return;
      }
      if (!Array.isArray(cohorts)) {
        console.error(`Expected an array for key '${key1}', but got:`, cohorts);
        return;
      }
      cohorts.forEach(cohortId => {
        fbq('trackCustom', 'Anon_Audience', { anon_cuid: anonId, audience_Id: cohortId });
        console.log('Sent custom event to pixel with params: ' + anonId + ', ' + cohortId);
        // WHere CAPI is implemented also POST to our Node server 
        fetch('/server', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                anon_cuid: anonId,
                audience_id: cohortId
            })
        });
        console.log('Sent custom event to CAPI with the params: ' + anonId + ', ' + cohortId);
      });
  })();
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=275230413602298&ev=PageView&noscript=1"
  /></noscript>
  <!-- End Meta Pixel Code -->
</head>
<body>
  <h1>SecureLift Demo</h1>
</body>
</html>
